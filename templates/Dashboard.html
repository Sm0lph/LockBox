<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LockBox - Dashboard</title>
    <link rel="icon" href="/static/images/icon.png" type="png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #EAF9FF, #FFFFFF);
        margin: 0;
        padding-top: 100px;
        min-height: 100vh;
    }

    /* Navbar */
    .navbar {
        position: fixed;           
        top: 0;
        left: 0;
        width: 100%;
        height: 80px; /* Keeps navbar height fixed */
        background-color: #004080;
        transition: background-color 0.3s ease-in-out;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 30px;
        z-index: 1000;
        overflow: visible;
    }

    .navbar-brand {
        display: flex;
        align-items: center;
    }

    .navbar-brand img {
        height: 80px;
    }

    /* Dropdown container */
.dropdown {
    position: relative;
    display: inline-block;
    margin-right: 80px; 
}

/* Dropdown button */
.dropbtn {
    margin: 0 80px 0 0; /* Apply 80px margin to the right */
    display: inline-block;
    background-color: #009973;
    color: white;
    padding: 10px 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.3s ease;
}

/* Dropdown button hover effect */
.dropbtn:hover {
    background-color: #45a049;
}

/* Dropdown content */
.dropdown-content {
    margin-right: 50px;
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
    z-index: 1;
    border-radius: 8px;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

/* Links inside the dropdown */
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    border-radius: 8px;
}

/* Hover effect for dropdown links */
.dropdown-content a:hover {
    background-color: #ddd;
}

/* Show the dropdown content when hovering over the button */
.dropdown:hover .dropdown-content {
    display: block;
    opacity: 1;
    transform: translateY(0);
}


    /* Hero Section */
    .dashboard-hero-section {
        position: relative;
        text-align: center;
        color: #000000;
        padding: 140px 20px 40px 20px;
        background-image: url("{{ url_for('static', filename='images/mesh_blended_with_blue.jpg') }}");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        animation: slideUp 1.2s ease-out;
    }

    .dashboard-hero-section::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 0;
        opacity: 0.6;
    }

    .dashboard-hero-section h1,
    .dashboard-hero-section p {
        position: relative;
        z-index: 1;
    }

    .dashboard-hero-section h1 {
        font-size: 3.5rem;
        font-weight: bold;
        animation: fadeIn 1.5s ease-out;
    }

    .dashboard-hero-section p {
        font-size: 1.2rem;
        color: #333;
        animation: fadeIn 2s ease-out;
    }

    /* Table Section */
    .dashboard-table-section {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
    }

   /* Styling for the table */
.table {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    animation: fadeIn 1.3s ease-in;
    margin-bottom: 30px;
    
}

.table th, .table td {
    padding: 16px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    width: 33%;
}

.table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.dotted-password {
    border-bottom: 2px dotted #000;
    cursor: pointer;
}

.btn-icon {
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.2rem;
    margin: 0 8px;
    color: #007bff;
    transition: color 0.2s;
    text-decoration: none;
}

.btn-icon:hover {
    color: #0056b3;
}

.btn-icon.delete:hover {
    color: #a00;
}

/* Button container */
.button-container {
    text-align: center;
    margin-top: 30px;
}

.button-container a {
    font-size: 1.1rem;
    padding: 12px 25px;
    background-color: #004080;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    margin: 10px;
    display: inline-block;
    transition: background-color 0.3s ease;
}

.button-container a:hover {
    background-color: #00264d;
}

/* No password message */
.no-passwords {
    text-align: center;
    font-size: 1.2rem;
    color: #777;
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    margin-top: 20px;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .navbar {
        flex-direction: column;
        padding: 15px;
        height: auto;
    }

    .dashboard-hero-section h1 {
        font-size: 2rem;
    }

    .table th, .table td {
        font-size: 0.9rem;
        padding: 12px;
    }
}

/* Styling for input fields */
.input-field {
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: calc(100% - 22px);  /* Ensures full width, considering padding */
    font-size: 16px;
    box-sizing: border-box;
    transition: border 0.3s ease;
}

.input-field:focus {
    border-color: #009973;
    outline: none;
}

/* Styling for buttons */
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

/* Primary (Save) button styling */
.primary-btn {
    background-color: #009973;
    color: white;
}

.primary-btn:hover {
    background-color: #45a049;
}

/* Cancel button styling */
.cancel-btn {
    background-color: #ccc;
    color: black;
    margin-left: 10px;
}

.cancel-btn:hover {
    background-color: #bbb;
}

/* Optional: Add some spacing between the form and its container */
#addPasswordForm {
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 1000px;
    margin: 0 auto;
}

#passwordTable{
    display: blocks;
}


/* Footer styling */
.footer {
    background-color: #004080; /* Dark blue background */
    color: #fff;
    padding: 1rem 0;
    text-align: center;
    position: relative;
    bottom: 0;
    width: 100%;
    margin-top: 7%;
}

.footer-container p {
    margin: 0;
    font-size: 0.9rem;
    font-family: 'Roboto', sans-serif;
}

/* Alert Container */
.alert-container {
    margin-top: 20px;
}

.alert {
    padding: 15px;
    align-content: center;
    margin-bottom: 20px;
    border-radius: 5px;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
}

</style>

</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='images/Lockbox_Logo.png') }}" alt="LockBox Logo" height="80">
            </a>
        </div>
        <div class="dropdown">
            <button class="dropbtn">Profile ‚ñº</button>
            <div class="dropdown-content">
                <a href="{{ url_for('home') }}"><i class="fas fa-home"></i> Home</a>
                <a href="{{ url_for('Dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="{{ url_for('Settings') }}"><i class="fas fa-cog"></i> Settings</a>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="dashboard-hero-section">
        <div class="dashboard-hero-content">
            <h1>Welcome back, {{ first_name }}!</h1>
            <p><b>Your password manager dashboard at LockBox. üîê</b></p>
        </div>
    </section>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" align="center">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

   <!-- Password Table Section -->
   <div class="dashboard-table-section">
    {% if passwords %}
        <!-- Show password table if passwords exist -->
        <table class="table" id="passwordTable">
            <thead>
                <tr>
                    <th>Website</th>
                    <th>Password</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for password in passwords %}
                    <tr>
                        <td>{{ password.website }}</td>
                        <td>
                            <span id="pwd-{{ password.id }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        </td>
                        <td>
                            <!-- View Button -->
                            <a href="javascript:void(0);" class="btn-icon view" title="View" onclick="viewPassword('{{ password.id }}')">
                                <i class="fas fa-eye"></i> 
                            </a>
                            <!-- Delete Button -->
                            <form id="deleteForm{{ password.id }}" action="{{ url_for('delete_password', id=password.id) }}" method="POST" style="display: none;">
                            </form>
                            <a href="javascript:void(0);" class="btn-icon delete" title="Delete" onclick="document.getElementById('deleteForm{{ password.id }}').submit();">
                                <i class="fas fa-trash"></i> <!-- Trash icon for delete -->
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <!-- Show "No Passwords" message if no passwords exist -->
        <div class="no-passwords" id="noPasswordsMsg">
            <i class="fas fa-lock fa-2x" style="margin-bottom: 10px; color: #004080;"></i>
            <p>You don't have any saved passwords just yet.</p>
        </div>
    {% endif %}
</div>

    <!-- Add Password Form (Initially Hidden) -->
    <div id="addPasswordForm" style="display: none; margin-top: 30px; align-items: center;">
        <form method="POST" action="{{ url_for('add_password') }}">
            <input type="text" name="website" id="website" placeholder="Website Name" required class="input-field">
            <input type="password" name="password"id="password" placeholder="Password" required class="input-field">
            <button type="button" class="btn primary-btn" id="saveButton">Save</button>
            <button type="button" class="btn cancel-btn" onclick="hideForm()">Cancel</button>
        </form>
    </div>

    <!-- Action Buttons -->
    <div class="button-container">
        <a href="#" id="addPasswordButton" onclick="toggleForm()"><i class="fas fa-plus-circle"></i> Add Password</a>
        <a href="{{ url_for('generator') }}" id="goToGeneratorButton" style="display: none;"><i class="fas fa-magic"></i> Generate Password</a>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@node-rs/argon2-web@1.0.0/dist/argon2.min.js"></script>
<script>
        // Encrypt password using AES-256 with PBKDF2 and generate salt/IV
        async function encryptPassword(plainPassword) {
            try {
                const aesKeyHex = sessionStorage.getItem("aesKey");
                if (!aesKeyHex) {
                    throw new Error("AES key not available. Please login again.");
                }

                // Use the stored key for encryption
                const key = CryptoJS.enc.Hex.parse(aesKeyHex);
                
                // Generate only IV (we don't need salt since we're using the master key)
                const iv = CryptoJS.lib.WordArray.random(128 / 8);

                // Encrypt password using the master key
                const encrypted = CryptoJS.AES.encrypt(plainPassword, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                return {
                    ciphertext: encrypted.toString(),
                    iv: iv.toString(CryptoJS.enc.Base64)
                };
            } catch (error) {
                console.error("‚ùå Encryption failed:", error);
                throw error;
            }
        }



        function decryptPassword(encryptedBase64, ivBase64) {
        try {
            const aesKeyHex = sessionStorage.getItem("aesKey");
            if (!aesKeyHex) {
                alert("AES key not available. Please login again.");
                return null;
            }

            const key = CryptoJS.enc.Hex.parse(aesKeyHex);
            const iv = CryptoJS.enc.Base64.parse(ivBase64);
            const decrypted = CryptoJS.AES.decrypt(encryptedBase64, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });


            const plaintext = decrypted.toString(CryptoJS.enc.Utf8);
            return plaintext || "[Failed to decrypt]";
        } catch (err) {
            console.error("‚ùå Decryption error:", err);
            return "[Failed to decrypt]";
        }
    }



        // ‚úÖ Derive AES key from master password & salt, store as hex
        async function deriveKey(masterPassword, master_salt) {
            try {
                const salt = CryptoJS.enc.Base64.parse(master_salt);
                const key = CryptoJS.PBKDF2(masterPassword, salt, {
                    keySize: 256 / 32,
                    iterations: 100000
                });

                const keyHex = key.toString(CryptoJS.enc.Hex);
                sessionStorage.setItem("aesKey", keyHex);
                sessionStorage.setItem("masterPassword", masterPassword); // cache for re-use
                return keyHex;
            } catch (error) {
                console.error("‚ùå Error deriving key:", error);
                return null;
            }
        }


    // -----------------------------------------------------------------------------------------------------------------


        async function viewPassword(passwordId) {
        try {
            const res = await fetch(`/get_encrypted_password?id=${passwordId}`);
            if (!res.ok) throw new Error("‚ùå Failed to fetch password.");

            const { encrypted_password, iv } = await res.json();

            let aesKeyHex = sessionStorage.getItem("aesKey");

            // üîÅ Fallback if aesKey is missing
            if (!aesKeyHex) {
                let masterPassword = sessionStorage.getItem("masterPassword");
                if (!masterPassword) {
                    masterPassword = prompt("üîê Enter your master password:");
                    if (!masterPassword) {
                        alert("Cancelled.");
                        return;
                    }
                }

                const masterSalt = sessionStorage.getItem("masterSalt");
                if (!masterSalt) {
                    alert("‚ùå Master salt not found. Please login again.");
                    return;
                }

                const derived = await deriveKey(masterPassword, masterSalt);
                if (!derived) {
                    alert("‚ùå Failed to derive key. Please login again.");
                    return;
                }
                aesKeyHex = derived;
            }

            // üß© Decrypt the password using correct IV from DB
            const decrypted = decryptPassword(encrypted_password, iv);
            document.getElementById(`pwd-${passwordId}`).innerText = decrypted;
        } catch (err) {
            console.error("‚ùå viewPassword failed:", err);
            alert("Failed to decrypt the password.");
        }
    }



    window.addEventListener('DOMContentLoaded', () => {
        // Debug: List all items in sessionStorage
        console.log("üîç All sessionStorage items:");
        for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            console.log(`${key}: ${sessionStorage.getItem(key)}`);
        }

        const aesKey = sessionStorage.getItem("aesKey");
        const masterSalt = sessionStorage.getItem("masterSalt");
        const userId = sessionStorage.getItem("userId");

        console.log("üì¶ SessionStorage on Dashboard:");
        console.log("üîë AES Key:", aesKey ?? '‚ùå Not Set');
        console.log("üßÇ Master Salt:", masterSalt ?? '‚ùå Not Set');
        console.log("üë§ User ID:", userId ?? '‚ùå Not Set');

        if (!aesKey || !masterSalt || !userId) {
            console.error("‚ùå Missing required session data!");
            window.location.href = "/login";
            return;
        }

        // If we get here, we have all required session data
        console.log("‚úÖ All required session data present");
    });

    // Log key parameters individually (in case names are mistyped)
    function logImportantSessionParams() {
        const aesKey = sessionStorage.getItem("aesKey");
        const masterSaltBase64 = sessionStorage.getItem("masterSalt"); // Correct key
        const userId = sessionStorage.getItem("userId");       // Correct key
    }


//-------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Handle Save Button Click Event
    document.getElementById('saveButton').addEventListener('click', async function(event) {
        event.preventDefault(); // Prevent form from submitting by default

        // Get form data
        const website = document.getElementById('website').value;
        const password = document.getElementById('password').value;

        console.log('Website:', website);
        console.log('Password:', password);

        // Encrypt the password using AES-256 encryption
        try {
            const encryptedData = await encryptPassword(password); // Encrypt the password

            console.log('Encrypted Data:', encryptedData); // Debugging line
            console.log("Website:", website);
            console.log("Password (before encryption):", password);
            
            // Prepare request data for POST request
            const requestData = {
                website: website,
                ciphertext: encryptedData.ciphertext,
                iv: encryptedData.iv
            };

            console.log("Request data:", requestData);

            // Send encrypted data via POST request to backend
            const response = await fetch("/add_password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData),
                credentials: "include" // Ensure session cookie is sent with request
            });

            // Get the raw response text
            const responseText = await response.text();
            console.log("Raw response from server:", responseText);

            // Ensure the response is valid JSON
            const result = JSON.parse(responseText);

            if (result.success) {
                hideFormOnSubmit();  // Hide the form after successful submission
                location.reload();   // Reload the page to show updated list
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            console.error("Encryption or request failed:", error);
            alert("An error occurred while adding the password.");
        }
    });

    // Toggle form visibility and store the form state in sessionStorage
    function toggleForm() {
        var form = document.getElementById('addPasswordForm');
        var passwordTable = document.getElementById('passwordTable');
        var noPasswordsMsg = document.getElementById('noPasswordsMsg');
        var addPasswordButton = document.getElementById("addPasswordButton");
        var goToGeneratorButton = document.getElementById("goToGeneratorButton");

        if (form.style.display === "none") {
            form.style.display = "block";
            if (passwordTable) passwordTable.style.display = "none";
            if (noPasswordsMsg) noPasswordsMsg.style.display = "none";
            addPasswordButton.style.display = "none";
            goToGeneratorButton.style.display = "inline-block";
            sessionStorage.setItem("formVisible", "true");
        } else {
            form.style.display = "none";
            if (passwordTable) passwordTable.style.display = "table";
            if (noPasswordsMsg) noPasswordsMsg.style.display = "block";
            addPasswordButton.style.display = "inline-block";
            goToGeneratorButton.style.display = "none";
            sessionStorage.setItem("formVisible", "false");
        }
    }
 //---------------------------------------------------------------------------------------------------------
        // Hide form and restore previous table visibility on cancel
        function hideForm() {
            var form = document.getElementById('addPasswordForm');
            var passwordTable = document.getElementById('passwordTable');
            var noPasswordsMsg = document.getElementById('noPasswordsMsg');
            var addPasswordButton = document.getElementById("addPasswordButton");
            var goToGeneratorButton = document.getElementById("goToGeneratorButton");

            form.style.display = "none";
            if (passwordTable) passwordTable.style.display = "table";
            if (noPasswordsMsg) noPasswordsMsg.style.display = "block";
            addPasswordButton.style.display = "inline-block";
            goToGeneratorButton.style.display = "none";
            sessionStorage.setItem("formVisible", "false");
        }

        // Hide form after successful submit
        function hideFormOnSubmit() {
            var form = document.getElementById('addPasswordForm');
            form.style.display = "none";
            document.getElementById("addPasswordButton").style.display = "block"; // Show "Add Password" button
            document.getElementById("goToGeneratorButton").style.display = "none"; // Hide "Go to Generator" button
        }

 //---------------------------------------------------------------------------------------------------------

        // When the page loads, hide the form
        document.addEventListener("DOMContentLoaded", function() {
        var addPasswordBtn = document.getElementById('addPasswordBtn');
        var form = document.getElementById('addPasswordForm');
        var table = document.getElementById('passwordTable');

        // Check if elements exist
        if (addPasswordBtn && form && table) {
            addPasswordBtn.onclick = function() {
                // Toggle visibility on button click
                if (form.style.visibility === 'hidden' || form.style.visibility === '') {
                    form.style.visibility = 'visible';  // Show form
                    table.style.visibility = 'hidden';  // Hide table
                } else {
                    form.style.visibility = 'hidden';  // Hide form
                    table.style.visibility = 'visible';  // Show table
                }
            };
        }
    });

</script>

    <!-- Footer Section -->
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 LockBox. All Rights Reserved.</p>
        </div>
    </footer>

</body> 
</html>
